<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Выбор треков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            padding: 12px;
            padding-bottom: 80px;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--tg-theme-bg-color, #fff);
            padding: 8px 0 12px;
            z-index: 100;
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
            margin-bottom: 12px;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
            margin-bottom: 10px;
        }

        .search-box::placeholder {
            color: var(--tg-theme-hint-color, #999);
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
        }

        .counter {
            margin-left: auto;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666);
        }

        .track-list {
            list-style: none;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
            gap: 10px;
        }

        .track-item.hidden {
            display: none;
        }

        .track-checkbox {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
            accent-color: var(--tg-theme-button-color, #3390ec);
        }

        .track-thumb {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--tg-theme-secondary-bg-color, #eee);
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title {
            font-size: 14px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .track-duration {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666);
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #666);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #666);
        }
    </style>
</head>
<body>
    <div class="header">
        <input type="text" class="search-box" id="search" placeholder="Поиск...">
        <div class="controls">
            <button class="btn btn-secondary" id="selectAll">Все</button>
            <button class="btn btn-secondary" id="deselectAll">Сброс</button>
            <span class="counter" id="counter">0 / 0</span>
        </div>
    </div>

    <ul class="track-list" id="trackList">
        <li class="loading">Загрузка...</li>
    </ul>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let tracks = [];
        let selectedIds = new Set();

        function decodeData() {
            const params = new URLSearchParams(window.location.search);
            const dataB64 = params.get('data');
            if (!dataB64) {
                return null;
            }
            try {
                // Декодируем base64 URL-safe в бинарные данные
                const base64 = dataB64.replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = atob(base64);

                // Конвертируем бинарную строку в Uint8Array
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Декодируем UTF-8
                const decoder = new TextDecoder('utf-8');
                const jsonString = decoder.decode(bytes);

                return JSON.parse(jsonString);
            } catch (e) {
                console.error('Failed to decode data:', e);
                return null;
            }
        }

        function updateCounter() {
            const counter = document.getElementById('counter');
            counter.textContent = `${selectedIds.size} / ${tracks.length}`;

            if (selectedIds.size > 0) {
                tg.MainButton.setText(`Скачать (${selectedIds.size})`);
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        function filterTracks(query) {
            const items = document.querySelectorAll('.track-item');
            const q = query.toLowerCase();
            items.forEach(item => {
                const title = item.dataset.title.toLowerCase();
                item.classList.toggle('hidden', !title.includes(q));
            });
        }

        function renderTracks() {
            const list = document.getElementById('trackList');

            if (!tracks.length) {
                list.innerHTML = '<li class="empty-state">Нет треков</li>';
                return;
            }

            list.innerHTML = tracks.map((track, index) => `
                <li class="track-item" data-id="${track.id}" data-title="${escapeAttr(track.title)}">
                    <input type="checkbox" class="track-checkbox" data-id="${track.id}">
                    <img class="track-thumb" src="${track.thumb}" alt="" loading="lazy">
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(track.title)}</div>
                        <div class="track-duration">${track.duration}</div>
                    </div>
                </li>
            `).join('');

            // Attach event listeners
            document.querySelectorAll('.track-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedIds.add(id);
                    } else {
                        selectedIds.delete(id);
                    }
                    updateCounter();
                });
            });

            // Click on row toggles checkbox
            document.querySelectorAll('.track-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    const cb = item.querySelector('.track-checkbox');
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function selectAll() {
            const visibleItems = document.querySelectorAll('.track-item:not(.hidden) .track-checkbox');
            visibleItems.forEach(cb => {
                cb.checked = true;
                selectedIds.add(cb.dataset.id);
            });
            updateCounter();
        }

        function deselectAll() {
            document.querySelectorAll('.track-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedIds.clear();
            updateCounter();
        }

        function sendData() {
            const data = {
                selected: Array.from(selectedIds)
            };

            // Показываем что отправляем
            tg.MainButton.setText('Отправка...');
            tg.MainButton.disable();

            try {
                tg.sendData(JSON.stringify(data));
                // Mini App должен закрыться автоматически после sendData
                // Но на всякий случай закрываем через 500мс
                setTimeout(() => tg.close(), 500);
            } catch (e) {
                alert('Ошибка отправки: ' + e.message);
                tg.MainButton.enable();
                tg.MainButton.setText(`Скачать (${selectedIds.size})`);
            }
        }

        // Init
        document.getElementById('search').addEventListener('input', (e) => {
            filterTracks(e.target.value);
        });

        document.getElementById('selectAll').addEventListener('click', selectAll);
        document.getElementById('deselectAll').addEventListener('click', deselectAll);

        tg.MainButton.onClick(sendData);
        tg.MainButton.setParams({
            color: tg.themeParams.button_color || '#3390ec',
            text_color: tg.themeParams.button_text_color || '#ffffff'
        });

        const data = decodeData();
        if (data && data.tracks) {
            tracks = data.tracks;
            renderTracks();
            updateCounter();
        } else {
            document.getElementById('trackList').innerHTML =
                '<li class="empty-state">Ошибка загрузки данных</li>';
        }
    </script>
</body>
</html>
